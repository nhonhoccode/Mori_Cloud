{% extends '../base/index.html' %}
{% load static %}

{% block title %}
Trash - MORI
{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/home.css' %}">

<section class="bg-white home-component">
    {% include '../header/index.html' %}

    <div class="">
        <div class="wrap-title mt-2">
            <h3 class="category-title">Th√πng r√°c</h3>
        </div>

        <!-- Tab Menu -->
        {% comment %} <ul class="nav nav-tabs mt-3" id="trashTabs">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-tab="tatca">T·∫•t c·∫£</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-tab="hinhanh">H√¨nh ·∫£nh</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-tab="folder">Folder</a>
            </li>
        </ul> {% endcomment %}

        <div class="alert alert-light mt-3" role="alert">
            M·ªçi thi·∫øt k·∫ø b·∫°n ƒë√£ x√≥a s·∫Ω n·∫±m ·ªü ƒë√¢y. B·∫°n s·∫Ω c√≥ <strong>30 ng√†y</strong> ƒë·ªÉ kh√¥i ph·ª•c tr∆∞·ªõc khi ch√∫ng b·ªã x√≥a t·ª± ƒë·ªông kh·ªèi Th√πng r√°c.
            <a href="#" class="text-primary">T√¨m hi·ªÉu th√™m</a>
        </div>

        <!-- Danh s√°ch ·∫£nh ƒë√£ x√≥a -->
        <div class="design-section row mt-2 px-2" id="trashItems">
            <div class="text-center">
                <img src="{% static 'default/no_data.png' %}" alt="Kh√¥ng c√≥ d·ªØ li·ªáu" class="img-fluid">
                <p class="text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
        </div>
    </div>
</section>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetchDeletedPhotos();
    
        const tabs = document.querySelectorAll('#trashTabs a');
        tabs.forEach(tab => {
            tab.addEventListener('click', (event) => {
                event.preventDefault();
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
    
                const selectedTab = tab.getAttribute('data-tab');
                filterTrashItems(selectedTab);
            });
        });
    });
    
    // üìå G·ªçi API ƒë·ªÉ l·∫•y danh s√°ch ·∫£nh ƒë√£ x√≥a
    async function fetchDeletedPhotos() {
        try {
            const response = await fetch('/photo/delete/', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Token ${localStorage.getItem('token')}`
                }
            });
    
            if (!response.ok) throw new Error('L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API');
    
            const photos = await response.json();
            renderTrashItems(photos);
        } catch (error) {
            console.error('L·ªói khi t·∫£i ·∫£nh ƒë√£ x√≥a:', error);
        }
    }
    
    // üìå Hi·ªÉn th·ªã danh s√°ch ·∫£nh trong th√πng r√°c
    function renderTrashItems(photos) {
        const trashContainer = document.getElementById('trashItems');
        trashContainer.innerHTML = '';
    
        if (photos.length === 0) {
            trashContainer.innerHTML = `
                <div class="text-center">
                    <img src="{% static '/default/no_folder.png' %}" alt="Kh√¥ng c√≥ d·ªØ li·ªáu" class="img-fluid">
                    <p class="text-muted">Kh√¥ng c√≥ ·∫£nh n√†o trong th√πng r√°c.</p>
                </div>
            `;
            return;
        }
    
        photos.forEach(photo => {
            const item = document.createElement('div');
            item.className = 'col-md-3 col-sm-6 p-2 item-img';
            item.dataset.type = 'hinhanh'; 
            item.innerHTML = `
                <div class="design-card">
                    <img src="${photo.photo.startsWith('/') ? photo.photo : '/media/' + photo.photo}" alt="${photo.name || 'Deleted Photo'}">
                    <div class="hover-overlay d-flex justify-content-center align-items-end">
                        <button class="btn btn-restore" onclick="restorePhotos([${photo.id_photo}])" title="Kh√¥i ph·ª•c">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-delete" onclick="permanentlyDeletePhotos([${photo.id_photo}])" title="X√≥a vƒ©nh vi·ªÖn">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${photo.name || 'Kh√¥ng c√≥ t√™n'}</h5>
                    <p class="card-text">${photo.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                </div>
            `;
            trashContainer.appendChild(item);
        });
    }
    
    // üìå Kh√¥i ph·ª•c ·∫£nh ƒë√£ x√≥a (H·ªó tr·ª£ kh√¥i ph·ª•c nhi·ªÅu ·∫£nh c√πng l√∫c)
    async function restorePhotos(photoIds) {
        try {
            const response = await fetch('/trash/restores/', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Token ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ "photo_ids": photoIds })
            });
    
            if (response.ok) {
                fetchDeletedPhotos(); // C·∫≠p nh·∫≠t giao di·ªán
            } else {
                console.error('L·ªói khi kh√¥i ph·ª•c ·∫£nh:', response.statusText);
            }
        } catch (error) {
            console.error('L·ªói khi kh√¥i ph·ª•c ·∫£nh:', error);
        }
    }
    
    // üìå X√≥a vƒ©nh vi·ªÖn ·∫£nh kh·ªèi th√πng r√°c (H·ªó tr·ª£ x√≥a nhi·ªÅu ·∫£nh c√πng l√∫c)
    async function permanentlyDeletePhotos(photoIds) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn ·∫£nh n√†y kh√¥ng?")) return;
    
        try {
            const response = await fetch('/trash/', {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Token ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ "photo_ids": photoIds })
            });
    
            if (response.ok) {
                fetchDeletedPhotos(); // C·∫≠p nh·∫≠t giao di·ªán sau khi x√≥a th√†nh c√¥ng
            } else {
                console.error('L·ªói khi x√≥a ·∫£nh:', response.statusText);
            }
        } catch (error) {
            console.error('L·ªói khi x√≥a ·∫£nh:', error);
        }
    }
    
    // üìå L·ªçc ·∫£nh theo tab "T·∫•t c·∫£", "H√¨nh ·∫£nh", "Folder"
    function filterTrashItems(selectedTab) {
        const items = document.querySelectorAll('#trashItems .item-img');
        items.forEach(item => {
            const itemType = item.getAttribute('data-type');
            item.style.display = (selectedTab === 'tatca' || itemType === selectedTab) ? 'block' : 'none';
        });
    }
    
</script>

{% endblock %}
