{% extends '../base/index.html' %}
{% load static %}

{% block title %}
Dashboard - MORI
{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/home.css' %}">

<section class="bg-white home-component">

    {% include '../header/index.html' %}

    <div class="top-bar-manage-img">
        <img src="https://static.canva.com/web/images/65d94392e6ba3b43d6e95be0e65ffed9.jpg" alt="Logo">
    </div>
    <div class="">
        <div class="icon-bar">
            <button><a href=""><span>‚ù§Ô∏è</span></a>
                <p>Y√™u th√≠ch</p>
            </button>
            <button><a href="/page/social"><span>üåê</span></a>
                <p>C·ªông d·ªìng</p>
            </button>
            <button class="upload" data-bs-toggle="modal" data-bs-target="#uploadModal"><span>‚òÅ</span>
                <p>T·∫£i l√™n</p>
            </button>
        </div>

        <div class="action-buttons">
            <button><a href="/page/social">üåà Chia s·∫ª c·∫£m x√∫c</a></button>
            <button class="btn-active-ai-home">‚ú® T√¨m ki·∫øm v·ªõi AI</button>
            <button><a href="/page/manage-imgs">ü¶Ñ Qu·∫£n l√Ω th√¥ng minh</a></button>
        </div>


        <div class="wrap-title mt-2">
            <h3 class="category-title">T·ªîNG QUAN</h3>
        </div>

        <div class="design-section row mt-2 px-2">
            {% comment %} <div class="col-xl-3 col-md-4 col-sm-6 p-2 item-img">
                <div class="design-card">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQVhsoYsUszzdWvBzAaK8kMYg1oqbjTnR-ZdQ&s"
                        alt="Design">
                    <div class="hover-overlay d-flex justify-content-center align-items-end">
                        <button class="btn btn-like">
                            <i class="fas fa-heart"></i>
                        </button>
                        <button class="btn btn-globe">
                            <i class="fas fa-globe"></i>
                        </button>
                        <button class="btn btn-folder">
                            <i class="fas fa-folder-open"></i>
                        </button>
                        <button class="btn btn-delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="card-title">Breast Cancer TNT-2024</h5>
                    <p class="card-text">B√†i thuy·∫øt tr√¨nh</p>
                </div>
            </div> {% endcomment %}
        </div>

        <!-- Modal Hi·ªÉn Th·ªã ·∫¢nh -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-body p-0">
                        <img id="enlargedImage" src="" alt="Enlarged Image" class="img-fluid w-100">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="default-img-not-data row mt-2 px-2 col-12 text-center">
            <img src="{% static 'default/no_folder.png' %}" alt="MORI" class="img-fluid">
        </div>

        <div class="modal fade" id="folderModal" tabindex="-1" aria-labelledby="folderModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="folderModalLabel">Ch·ªçn Folder</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <div class="row" id="folderGrid">
                                <!-- C√°c folder s·∫Ω ƒë∆∞·ª£c render theo d·∫°ng l∆∞·ªõi -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                        <button type="button" class="btn btn-primary" id="selectFolderBtn">ƒê·ªìng √Ω</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="editInfoModal" tabindex="-1" aria-labelledby="editInfoModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editInfoModalLabel" style="color: black !important;">Ch·ªânh s·ª≠a th√¥ng tin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editInfoForm">
                            <div class="mb-1">
                                <label for="inputName" class="form-label" style="color: black !important;">Name</label>
                                <input type="text" class="form-control" id="inputName" placeholder="Nh·∫≠p t√™n">
                            </div>
                            <div class="mb-1">
                                <label for="inputCaption" class="form-label" style="color: black !important;">Caption</label>
                                <input type="text" class="form-control" id="inputCaption" placeholder="Nh·∫≠p caption">
                            </div>
                            <div class="mb-1">
                                <label for="inputDescription" class="form-label" style="color: black !important;">Description</label>
                                <textarea class="form-control" id="inputDescription" rows="3"
                                    placeholder="Nh·∫≠p description"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                        <button type="button" class="btn btn-primary" id="saveChangesBtn">L∆∞u thay ƒë·ªïi</button>
                    </div>
                </div>
            </div>
        </div>



    </div>
</section>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const btn_active_ai_home = document.querySelector('.btn-active-ai-home');
        const aiIcon = document.querySelector('.search-icon-ai');
        const input = document.querySelector('#searchQuery');


        btn_active_ai_home.addEventListener('click', function () {
            aiIcon.classList.toggle('active_ai');
            input.focus();
        });
    });

</script>


<script>
    const token = "{{ token|default:'' }}";
    console.log("üîê Token Knox: ", token);

    if (token) {
        console.log("‚úÖ Token Knox: ", token);
        localStorage.setItem('token', token);
        console.log("‚úÖ Token ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o LocalStorage");
    } else {
        console.warn("‚ö†Ô∏è Kh√¥ng c√≥ token n√†o ƒë∆∞·ª£c t·∫°o");
    }

    const headers = {
        'Authorization': `Token ${localStorage.getItem('token')}`, // Replace with actual token
    }


    document.addEventListener("DOMContentLoaded", function () {
        function fetchPhotos() {
            fetch('/photo/', {
                    method: 'GET',
                    headers
                })
                .then(response => response.json())
                .then(data => {
                    const designSection = document.querySelector('.design-section');
                    const defaultImgSection = document.querySelector('.default-img-not-data');
                    defaultImgSection.style.display = 'none';

                    if (data.length === 0) {
                        // No photos, show the default "no images" message
                        defaultImgSection.style.display = 'block';
                    } else {
                        // Loop through the data and add images to the design section
                        data.slice(0,8).forEach(photo => {
                            const photoCard = document.createElement('div');
                            photoCard.classList.add('col-xl-3', 'col-md-4', 'col-sm-6', 'p-2', 'item-img');

                            photoCard.innerHTML = `
                            <div class="design-card" 
                                data-photo-id="${photo.id_photo}" 
                                data-album-id="${photo.album}" 
                                data-is-public="${photo.is_public}"
                                data-is-favorite="${photo.is_favorited}"
                            >
                                <img src="${photo.photo}" alt="Design">
                                <div class="hover-overlay d-flex justify-content-center align-items-end">
                                    {% comment %} <button class="btn btn-like">
                                        ${photo.is_favorited ? '<i class="fas fa-heart red-heart"></i>' : '<i class="far fa-heart"></i>'}
                                    </button> {% endcomment %}
                                    <button class="btn btn-globe">
                                        ${photo.is_public ? '<i class="fas fa-globe"></i>' : '<i class="fas fa-lock"></i>'}
                                    </button>
                                    <button class="btn btn-folder">
                                        <i class="fas fa-folder-open"></i>
                                    </button>
                                    <button class="btn btn-edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">${photo.name || ''}</h5>
                                <p class="card-text">${photo.caption || ''}</p>
                            </div>
                        `;

                            designSection.appendChild(photoCard);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching photos:', error);
                });
        }
        fetchPhotos();

        function fetchFolders() {
            fetch('/album', {
                    method: 'GET',
                    headers
                })
                .then(response => response.json())
                .then(data => {
                    const albumContainer = document.getElementById("folderGrid");
                    albumContainer.innerHTML = ''; // X√≥a d·ªØ li·ªáu c≈© tr∆∞·ªõc khi render album m·ªõi

                    {% comment %} console.log('Albums:', data); {% endcomment %}

                    data.forEach(album => {
                        const col = document.createElement('div');
                        col.classList.add('col-4', 'mb-3');

                        const card = document.createElement('div');
                        card.classList.add('card', 'folder-card');
                        card.style.cursor = 'pointer';
                        card.setAttribute('data-id', album.id_album);
                        card.innerHTML = `
                        <div class="card-body text-center">
                            <i class="fas fa-folder fa-3x"></i>
                            <p class="mt-2">${album.title}</p>
                        </div>
                    `;

                        // Event listener for folder card click using event delegation
                        card.addEventListener('click', () => {
                            document.querySelectorAll('.folder-card').forEach(item => item
                                .classList
                                .remove('active'));
                            card.classList.add('active');
                        });

                        col.appendChild(card);
                        folderGrid.appendChild(col);
                    });
                })
                .catch(error => console.error("Error fetching albums:", error));
        }
        fetchFolders(); // G·ªçi API fetch album ngay khi t·∫£i trang


        // Use Event Delegation to handle the folder button clicks
        document.querySelector('.design-section').addEventListener('click', function (event) {
            if (event.target.closest('.btn.btn-folder')) {
                console.log("üìÅ Folder button clicked");

                const folderButton = event.target.closest('.btn.btn-folder');
                const photoCard = folderButton.closest('.design-card');
                const photoId = photoCard.getAttribute('data-photo-id');

                console.log("üì∏ Photo ID:", photoId);

                if (!photoId) {
                    console.error("‚ùå Kh√¥ng t√¨m th·∫•y ID ·∫£nh!");
                    return;
                }

                // Hi·ªÉn th·ªã modal ch·ªçn folder
                const folderModal = new bootstrap.Modal(document.getElementById('folderModal'));
                folderModal.show();

                // X·ª≠ l√Ω s·ª± ki·ªán khi ch·ªçn folder v√† nh·∫•n "ƒê·ªìng √Ω"
                document.getElementById('selectFolderBtn').addEventListener('click', function () {
                    const selectedCard = document.querySelector('.folder-card.active');

                    if (!selectedCard) {
                        alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt folder tr∆∞·ªõc khi x√°c nh·∫≠n!");
                        return;
                    }

                    const folderId = selectedCard.getAttribute('data-id');
                    const folderName = selectedCard.querySelector('p').textContent;

                    console.log(`üìÅ Folder ƒë∆∞·ª£c ch·ªçn: ID ${folderId}, T√™n: ${folderName}`);

                    // ƒê·ªãnh d·∫°ng d·ªØ li·ªáu JSON ƒë·ªÉ g·ª≠i ƒë·∫øn API
                    const requestData = [{
                        "id_photo": parseInt(photoId, 10),
                        "album": parseInt(folderId, 10)
                    }];

                    console.log("üì° G·ª≠i request PUT:", requestData);

                    // G·ª≠i request PUT ƒë·∫øn API
                    fetch('/photo/info/', {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Token ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'X-CSRFTOKEN': localStorage.getItem('csrftoken')
                            },
                            body: JSON.stringify(requestData)
                        })
                        .then(response => {
                            console.log("üì° Server response status:", response.status);
                            if (response.ok) {
                                return response.json();
                            } else {
                                return response.json().then(errData => {
                                    throw new Error(errData.detail ||
                                        "‚ö†Ô∏è L·ªói khi c·∫≠p nh·∫≠t album.");
                                });
                            }
                        })
                        .then(data => {
                            console.log(
                                `‚úÖ ·∫¢nh ID ${photoId} ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√†o Album ID ${folderId}.`,
                                data);
                            folderModal.hide(); // ƒê√≥ng modal sau khi th√†nh c√¥ng
                            window.location.reload(); // C·∫≠p nh·∫≠t giao di·ªán
                        })
                        .catch(error => console.error("‚ùå L·ªói c·∫≠p nh·∫≠t album:", error));
                }, {
                    once: true
                }); // `once: true` ƒë·ªÉ tr√°nh g·∫Øn nhi·ªÅu s·ª± ki·ªán click
            }

            if (event.target.closest('.design-card img')) {
                // Handle image click
                const img = event.target.closest('.design-card img');
                const imgSrc = img.getAttribute('src');
                const photoId = img.closest('.design-card').getAttribute('data-photo-id');

                // Update src for the enlarged image in modal
                const enlargedImage = document.getElementById('enlargedImage');
                enlargedImage.src = imgSrc;

                // Show the modal using Bootstrap Modal
                const imageModalEl = document.getElementById('imageModal');
                const imageModal = new bootstrap.Modal(imageModalEl);
                imageModal.show();
            }

            if (event.target.closest('.btn-delete')) {
                const photoCard = event.target.closest('.design-card');
                const cardBody = event.target.closest('.card-body');
                const photoId = photoCard.getAttribute("data-photo-id");

                if (!photoId) {
                    console.error("Photo ID not found.");
                    return;
                }

                // X√°c nh·∫≠n x√≥a tr∆∞·ªõc khi g·ª≠i request
                if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh ID ${photoId} kh√¥ng?`)) {
                    return;
                }

                fetch(`/photo/delete/`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Token ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRFTOKEN': localStorage.getItem(
                                'csrftoken') // L∆∞u √Ω: C·∫ßn ƒë·∫£m b·∫£o CSRF token ƒë∆∞·ª£c l∆∞u
                        },
                        body: JSON.stringify({
                            "photos": [parseInt(photoId)] // Chuy·ªÉn ID ·∫£nh th√†nh s·ªë nguy√™n
                        })
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                            console.log(`Photo with ID ${photoId} deleted successfully.`);
                        } else {
                            return response.json().then(errData => {
                                throw new Error(errData.detail ||
                                "Failed to delete photo.");
                            });
                        }
                    })
                    .catch(error => console.error("Error deleting photo:", error));
            }

            if (event.target.closest('.btn-like')) {
                const photoCard = event.target.closest('.design-card');
                const photoId = photoCard.getAttribute("data-photo-id");
                const isFavorite = photoCard.getAttribute("data-is-favorite");

                if (!photoId) {
                    console.error("Photo ID not found.");
                    return;
                }

                if (!isFavorite) {
                    fetch(`/favorite/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Token ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'X-CSRFTOKEN': localStorage.getItem(
                                    'csrftoken') // C·∫ßn ƒë·∫£m b·∫£o CSRF token h·ª£p l·ªá
                            },
                            body: JSON.stringify({
                                "photos": [{
                                    "id_photo": parseInt(
                                    photoId), // Chuy·ªÉn ID ·∫£nh th√†nh s·ªë nguy√™n
                                    "note": "Favorite image" // Ghi ch√∫ t√πy ch·ªçn
                                }]
                            })
                        })
                        .then(response => {
                            if (response.ok) {
                                console.log(`Photo with ID ${photoId} added to favorites.`);
                                // C·∫≠p nh·∫≠t UI: ƒê·ªïi m√†u n√∫t ho·∫∑c th√™m hi·ªáu ·ª©ng y√™u th√≠ch
                                event.target.classList.add(
                                "favorited"); // Th√™m class ƒë·ªÉ thay ƒë·ªïi giao di·ªán
                            } else {
                                return response.json().then(errData => {
                                    throw new Error(errData.detail ||
                                        "Failed to favorite photo.");
                                });
                            }
                        })
                        .catch(error => console.error("Error favoriting photo:", error));
                } else {
                    fetch(`/favorite/`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Token ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'X-CSRFTOKEN': localStorage.getItem(
                                    'csrftoken') // C·∫ßn ƒë·∫£m b·∫£o CSRF token h·ª£p l·ªá
                            },
                            body: JSON.stringify({
                                "photos": [{
                                    "id_photos": parseInt(
                                    photoId), // Chuy·ªÉn ID ·∫£nh th√†nh s·ªë nguy√™n
                                }]
                            })
                        })
                        .then(response => {
                            if (response.ok) {
                                console.log(`Photo with ID ${photoId} removed from favorites.`);
                                // C·∫≠p nh·∫≠t UI: ƒê·ªïi m√†u n√∫t ho·∫∑c th√™m hi·ªáu ·ª©ng y√™u th√≠ch
                                event.target.classList.remove(
                                "favorited"); // X√≥a class ƒë·ªÉ thay ƒë·ªïi giao di·ªán
                            } else {
                                return response.json().then(errData => {
                                    throw new Error(errData.detail ||
                                        "Failed to unfavorite photo.");
                                });
                            }
                        })
                        .catch(error => console.error("Error unfavoriting photo:", error));
                }
            }

            if (event.target.closest('.btn-globe')) {
                const globeButton = event.target.closest('.btn-globe');
                const photoCard = globeButton.closest('.design-card');

                // L·∫•y ID ·∫£nh v√† album t·ª´ thu·ªôc t√≠nh data
                const photoId = photoCard.getAttribute("data-photo-id");
                const albumId = photoCard.getAttribute("data-album-id");
                var isPublic = photoCard.getAttribute("data-is-public");

                isPublic = isPublic === "true" ? false : true;

                if (!photoId || !albumId) {
                    console.error("Photo ID ho·∫∑c Album ID kh√¥ng t√¨m th·∫•y.");
                    return;
                }

                // ƒê·ªãnh d·∫°ng d·ªØ li·ªáu JSON ƒë·ªÉ g·ª≠i t·ªõi API
                const requestData = [{
                        "id_photo": parseInt(photoId, 10),
                        "album": parseInt(albumId, 10),
                        "is_public": isPublic // Chuy·ªÉn ƒë·ªïi gi√° tr·ªã boolean ng∆∞·ª£c
                    } // B·∫°n c√≥ th·ªÉ thay ƒë·ªïi n·∫øu c·∫ßn
                ];

                // G·ª≠i request PUT t·ªõi API
                fetch(`/photo/info/`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Token ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRFTOKEN': localStorage.getItem('csrftoken')
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                            return response.json();
                        } else {
                            return response.json().then(errData => {
                                throw new Error(errData.detail ||
                                    "Failed to update photo info.");
                            });
                        }
                    })
                    .then(data => {
                        console.log(`Photo ID ${photoId} updated successfully in Album ${albumId}.`,
                            data);
                    })
                    .catch(error => console.error("Error updating photo info:", error));
            }

            if (event.target.closest('.btn-edit')) {
                const photoCard = event.target.closest('.design-card');
                const photoId = photoCard.getAttribute("data-photo-id");
                const albumId = photoCard.getAttribute("data-album-id");
                
                // Find the card title and text related to this specific photo
                const cardContainer = photoCard.closest('.item-img');
                const cardTitle = cardContainer.querySelector(".card-title");
                const cardText = cardContainer.querySelector(".card-text");
                
                if (!photoId) {
                    console.error("Photo ID not found.");
                    return;
                }
            
                // L∆∞u gi√° tr·ªã photoId, albumId v√†o modal ƒë·ªÉ s·ª≠ d·ª•ng sau
                const editModal = document.getElementById("editInfoModal");
                editModal.dataset.photoId = photoId;
                editModal.dataset.albumId = albumId;
            
                // Get current data from the clicked card
                document.getElementById("inputName").value = cardTitle ? cardTitle.textContent || "" : "";
                document.getElementById("inputCaption").value = cardText ? cardText.textContent || "" : "";
                document.getElementById("inputDescription").value = ""; // Reset description field
            
                // Hi·ªÉn th·ªã modal b·∫±ng Bootstrap Modal API
                const bsModal = new bootstrap.Modal(editModal);
                bsModal.show();
            
                // ƒêƒÉng k√Ω s·ª± ki·ªán cho n√∫t "L∆∞u thay ƒë·ªïi" trong modal, ch·ªâ th·ª±c hi·ªán 1 l·∫ßn
                document.getElementById("saveChangesBtn").addEventListener("click", function handler() {
                    const nameValue = document.getElementById("inputName").value;
                    const captionValue = document.getElementById("inputCaption").value;
                    const descriptionValue = document.getElementById("inputDescription").value;
            
                    // T·∫°o d·ªØ li·ªáu JSON theo ƒë·ªãnh d·∫°ng y√™u c·∫ßu
                    const data = [{
                        id_photo: parseInt(photoId, 10),
                        album: parseInt(albumId, 10),
                        ...(nameValue ? { name: nameValue } : {}),
                        ...(captionValue ? { caption: captionValue } : {}),
                        ...(descriptionValue ? { description: descriptionValue } : {})
                    }];
                    
                    fetch("/photo/info/", {
                            method: "PUT",
                            headers: {
                                "accept": "application/json",
                                'Authorization': `Token ${localStorage.getItem('token')}`,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(data)
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Network response was not ok");
                            }
                            return response.json();
                        })
                        .then(json => {
                            console.log("Success:", json);
                            bsModal.hide();
                            window.location.reload();
                        })
                        .catch(error => {
                            console.error("Error:", error);
                        });
            
                    // X√≥a s·ª± ki·ªán sau khi ƒë√£ th·ª±c hi·ªán ƒë·ªÉ tr√°nh l·∫∑p l·∫°i khi m·ªü modal l·∫ßn sau
                    this.removeEventListener("click", handler);
                }, { once: true });
            }

        });
    });
</script>

{% endblock %}