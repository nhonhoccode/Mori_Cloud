{% extends '../base/index.html' %}
{% load static %}

{% block title %}
Qu·∫£n l√≠ ·∫£nh - MORI
{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<link rel="stylesheet" href="{% static 'css/manage-img.css' %}">
<!-- Bootstrap JS (g·ªìm Popper b√™n trong lu√¥n) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<section class="bg-white home-component">
    {% include '../header/index.html' %}
    <div class="top-bar-manage-img">
        <img src="https://static.canva.com/web/images/4a825d24e6fb578c2ff6061aade52217.jpg" alt="Logo">
    </div>

    <!-- Navbar -->
    <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="filter-buttons">
                {% comment %} <button class="btn btn-light">Ch·ªß s·ªü h·ªØu</button> {% endcomment %}
                <div class="btn-group">
                    <button class="btn btn-light dropdown-toggle" type="button" id="communityFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        C·ªông ƒë·ªìng
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="communityFilterDropdown">
                        <li><a class="dropdown-item" href="#" data-public-filter="all">T·∫•t c·∫£</a></li>
                        <li><a class="dropdown-item" href="#" data-public-filter="true">C·ªông ƒë·ªìng</a></li>
                        <li><a class="dropdown-item" href="#" data-public-filter="false">Kh√¥ng c·ªông ƒë·ªìng</a></li>
                    </ul>
                </div>
                {% comment %} <button class="btn btn-light">Ng√†y s·ª≠a ƒë·ªïi</button> {% endcomment %}
            </div>

            

            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNewModal">
                    + Th√™m m·ªõi
                </button>
                <div class="modal fade" id="addNewModal" tabindex="-1" aria-labelledby="addNewModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <!-- modal-xl ƒë·ªÉ modal r·ªông h∆°n -->
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addNewModalLabel">T·∫°o th∆∞ m·ª•c m·ªõi</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="ƒê√≥ng"></button>
                            </div>
                            <div class="modal-body">
                                <!-- √î nh·∫≠p t√™n th∆∞ m·ª•c -->
                                <div class="form-floating mb-2">
                                    <input type="text" class="form-control" id="folderName"
                                        placeholder="Nh·∫≠p t√™n th∆∞ m·ª•c">
                                    <label class="folderName" for="folderName">Nh·∫≠p t√™n th∆∞ m·ª•c m·ªõi</label>
                                </div>
                                <div class="form-floating mb-4">
                                    <input type="text" class="form-control" id="description"
                                        placeholder="Nh·∫≠p t√™n th∆∞ m·ª•c">
                                    <label class="description" style="color: #ccc;" for="description">Nh·∫≠p m√¥ t·∫£ th∆∞ m·ª•c m·ªõi</label>
                                </div>
                                <!-- Danh s√°ch ·∫£nh d·∫°ng l∆∞·ªõi -->
                                <div class="row g-3 wrap-img-choose">
                                    <!-- ·∫¢nh 1 -->
                                    {% comment %} <div class="col-6 col-md-4 col-lg-3">
                                        <div class="card card-img-select shadow-sm" data-select="false">
                                            <!-- Checkbox tr√™n c√πng b√™n ph·∫£i -->
                                            <input type="checkbox" class="select-checkbox" />
                                            <img src="https://i.pravatar.cc/200?img=10"
                                                class="card-img-top clickable-img" alt="·∫¢nh 1">
                                        </div>
                                    </div> {% endcomment %}
                                    <!-- Th√™m c√°c c·ªôt t∆∞∆°ng t·ª± cho c√°c ·∫£nh kh√°c -->
                                </div>
                                <!-- End row -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                                <button type="button" class="btn btn-primary">L∆∞u</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-menu d-flex mt-2">
        <a href="#" data-tab="all" class="active">T·∫•t c·∫£</a>
        <a href="#" data-tab="photo">·∫¢nh</a>
        <a href="#" data-tab="album">Album</a>
    </div>

    <div class="design-section row mt-4 px-2">
        <!-- Cards will be dynamically generated here -->
    </div>

    <div class="default-img-not-data row mt-2 px-2 text-center">
        <img src="{% static 'default/no_folder.png' %}" alt="MORI" class="img-fluid">
    </div>

    <div class="modal fade" id="folderModal" tabindex="-1" aria-labelledby="folderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="folderModalLabel">Ch·ªçn Folder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row" id="folderGrid">
                            <!-- C√°c folder s·∫Ω ƒë∆∞·ª£c render theo d·∫°ng l∆∞·ªõi -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" id="selectFolderBtn">ƒê·ªìng √Ω</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="editInfoModal" tabindex="-1" aria-labelledby="editInfoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInfoModalLabel" style="color: black !important;">Ch·ªânh s·ª≠a th√¥ng tin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>
                <div class="modal-body">
                    <form id="editInfoForm">
                        <div class="mb-1">
                            <label for="inputName" class="form-label" style="color: black !important;">T√™n ·∫£nh</label>
                            <input type="text" class="form-control" id="inputName" placeholder="Nh·∫≠p t√™n">
                        </div>
                        <div class="mb-1">
                            <label for="inputCaption" class="form-label" style="color: black !important;">M√¥ t·∫£</label>
                            <input type="text" class="form-control" id="inputCaption" placeholder="Nh·∫≠p caption">
                        </div>
                        <div class="mb-1">
                            <label for="inputDescription" class="form-label" style="color: black !important;">Caption</label>
                            <textarea class="form-control" id="inputDescription" rows="3"
                                placeholder="Nh·∫≠p description"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" id="saveChangesBtn">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</section>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            
            function checkEmptyState() {
                const items = document.querySelectorAll('.design-section .item-img');
                const hasVisibleItem = Array.from(items).some(item => window.getComputedStyle(item).display !== 'none');

                if(items.length === 0 || !hasVisibleItem) {
                    document.querySelector('.default-img-not-data').style.display = 'block';
                } else {
                    document.querySelector('.default-img-not-data').style.display = 'none';
                }
            }

            function fetchPhotos() {
                fetch('/photo/', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Token ${localStorage.getItem('token')}`,
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        const photoContainer = document.querySelector(".wrap-img-choose");
                        data.forEach(photo => {
                            const photoCard = document.createElement("div");
                            photoCard.classList.add("col-6", "col-md-4", "col-lg-3");
        
                            const isFavoritedClass = photo.is_favorited ? "favorited" : "";
        
                            photoCard.innerHTML = `
                                <div class="card card-img-select shadow-sm ${isFavoritedClass}" data-photo-id="${photo.id_photo}" data-select="false">
                                    <input type="checkbox" class="select-checkbox" data-photo-id="${photo.id_photo}"/>
                                    <img src="${photo.photo}" class="card-img-top clickable-img" alt="·∫¢nh ${photo.id_photo}">
                                </div>
                            `;
                            photoContainer.appendChild(photoCard);
                        });


                        // Check empty state
                        const designSection = document.querySelector(".design-section");
                        
                        data.forEach(photo => {
                            const photoCard = document.createElement("div");
                            
                            photoCard.setAttribute('data-type', 'photo');
                            photoCard.classList.add("col-xl-3", "col-md-4", "col-sm-6", "p-2", "item-img");
        
                            const isFavoritedClass = photo.is_favorited ? "favorited" : "";
        
                            photoCard.innerHTML = `
                                <div class="design-card" 
                                    data-photo-id="${photo.id_photo}" 
                                    data-album-id="${photo.album}" 
                                    data-is-public="${photo.is_public}"
                                    data-is-favorite="${photo.is_favorited}"
                                >
                                    <img src="${photo.photo}" alt="Design">
                                    <div class="hover-overlay d-flex justify-content-center align-items-end">
                                        {% comment %} <button class="btn btn-like">
                                            ${photo.is_favorited ? '<i class="fas fa-heart red-heart"></i>' : '<i class="far fa-heart"></i>'}
                                        </button> {% endcomment %}
                                        <button class="btn btn-globe">
                                            ${photo.is_public ? '<i class="fas fa-globe"></i>' : '<i class="fas fa-lock"></i>'}
                                        </button>
                                        <button class="btn btn-folder">
                                            <i class="fas fa-folder-open"></i>
                                        </button>
                                        <button class="btn btn-edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">${photo.name || ''}</h5>
                                    <p class="card-text">${photo.caption || ''}</p>
                                </div>
                            `;
                            designSection.appendChild(photoCard);
                        });


                        checkEmptyState();

                    })
                    .catch(error => console.error("Error fetching photos:", error));
            }
        
            function fetchAlbums() {
                fetch('/album/', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Token ${localStorage.getItem('token')}`,
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        const albumContainer = document.querySelector(".design-section");
        
                        {% comment %} if (data.length === 1) {
                            albumContainer.innerHTML = `
                                <div class="col-12 text-center">
                                    <img src="{% static 'default/no_folder.png' %}" alt="Kh√¥ng c√≥ album" class="img-fluid">
                                    <p class="text-muted">Kh√¥ng c√≥ album n√†o</p>
                                </div>
                            `;
                            return;
                        } {% endcomment %}

                        data.slice(1).forEach(album => {
                            const albumCard = document.createElement("div");
                            // add data-type
                            albumCard.setAttribute('data-type', 'album');
                            albumCard.classList.add("col-xl-3", "col-md-4", "col-sm-6", "p-2", "item-img");
        
                            const albumCover = album.photos.length > 0 ? album.photos[0].photo : "{% static 'default/no_folder.png' %}";
        
                            albumCard.innerHTML = `
                                <div class="wrap-folder" data-album-id="${album.id_album}">
                                    <div class="design-folder">
                                        ${album.photos.slice(0, 3).map(photo => {
                                                return `<img src="${photo.photo}" alt="Design">`
                                                }).join('')
                                            }
                                        <div class="hover-overlay d-flex justify-content-center align-items-end">
                                            {% comment %} <button class="btn btn-folder">
                                                <i class="fas fa-folder-open"></i>
                                            </button> {% endcomment %}
                                            <button class="btn btn-delete">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="folder-body">
                                        <h5 class="folder-title">${album.title}</h5>
                                        <p class="folder-text">S·ªë l∆∞·ª£ng: ${album.photos.length}</p>
                                    </div>
                                </div>
                            `;
                            albumContainer.appendChild(albumCard);
                        });
                    })
                    .catch(error => console.error("Error fetching albums:", error));
            }
        
            fetchPhotos(); // G·ªçi API ƒë·ªÉ t·∫£i danh s√°ch ·∫£nh
            fetchAlbums(); // G·ªçi API ƒë·ªÉ t·∫£i danh s√°ch album
        
            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("clickable-img")) {
                    const card = e.target.closest(".card-img-select");
                    const isSelected = card.getAttribute("data-select") === "true";
                    card.setAttribute("data-select", isSelected ? "false" : "true");
        
                    const checkbox = card.querySelector(".select-checkbox");
                    checkbox.checked = !isSelected;
                }
            });
        
            document.querySelector("#addNewModal .btn-primary").addEventListener("click", function () {
                const selectedPhotos = [];
                document.querySelectorAll(".card-img-select[data-select='true']").forEach(card => {
                    const photoId = card.getAttribute("data-photo-id");
                    selectedPhotos.push(parseInt(photoId));
                });
        
                {% comment %} if (selectedPhotos.length === 0) {
                    alert("B·∫°n ch∆∞a ch·ªçn ·∫£nh n√†o!");
                    return;
                } {% endcomment %}

                const folderName = document.querySelector("#folderName").value;
                const description = document.querySelector("#description").value;
                if (!folderName) {
                    alert("Vui l√≤ng nh·∫≠p t√™n th∆∞ m·ª•c!");
                    return;
                }
        
                fetch('/album/', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Token ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRFTOKEN': localStorage.getItem('csrftoken')
                        },
                        body: JSON.stringify([{
                            title: folderName,
                            description: description,
                        }])
                    })
                    .then(response => response.json()) // Chuy·ªÉn response th√†nh JSON
                .then(data => {
                    console.log("Response Data:", data.albums);
                
                    if (data && data.albums && data.albums[0].id) {  // Ki·ªÉm tra n·∫øu API tr·∫£ v·ªÅ ID c·ªßa album
                        const albumId = data.albums[0].id;
                const selectedPhotos = [];
                document.querySelectorAll(".card-img-select[data-select='true']").forEach(card => {
                    const photoId = card.getAttribute("data-photo-id");
                    selectedPhotos.push({
                        id_photo: parseInt(photoId),
                        album: albumId
                    });
                });

                if (selectedPhotos.length === 0) {
                    alert("Kh√¥ng c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ th√™m v√†o album.");
                    return;
                }
                // G·ªçi API PUT ƒë·ªÉ c·∫≠p nh·∫≠t ·∫£nh v√†o album
                fetch('/photo/info/', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Token ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRFTOKEN': localStorage.getItem('csrftoken')
                    },
                    body: JSON.stringify(selectedPhotos)
                })
                .then(response => response.json())
                .then(photoData => {
                    console.log("Photos updated successfully:", photoData);
                    Toastify({
                        text: "T·∫°o Album th√†nh c√¥ng!",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#4caf50", // M√†u xanh cho th√†nh c√¥ng
                        stopOnFocus: true,
                    }).showToast();
                    fetchAlbums(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch album
                    checkEmptyState(); // Ki·ªÉm tra tr·∫°ng th√°i hi·ªÉn th·ªã
                    // close modal
                    document.querySelector("#addNewModal .btn-close").click();
                    // clear input
                    document.querySelector("#folderName").value = "";
                    document.querySelector("#description").value = "";
                    document.querySelectorAll(".card-img-select").forEach(card => {
                        card.setAttribute("data-select", "false");
                        card.querySelector(".select-checkbox").checked = false;
                    });

                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);

                })
                .catch(error => console.error("Error updating photos:", error));
                    } else {
                        throw new Error(data.detail || "L·ªói khi t·∫°o album.");
                    }
                })
                .catch(error => console.error("Error creating album:", error));
                });

                
        
            document.querySelector(".design-section").addEventListener("click", function (event) {
                const deleteButton = event.target.closest(".btn-delete");
                const folder = event.target.closest(".wrap-folder")

                
                if (deleteButton) {
                    const albumElement = deleteButton.closest(".wrap-folder");
                    const albumId = albumElement.getAttribute("data-album-id");
            
                    if (!albumId) {
                        console.error("Album ID not found!");
                        return;
                    }
            
                    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a album n√†y kh√¥ng?")) {
                        return;
                    }
            
                    fetch(`/album/`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Token ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRFTOKEN': localStorage.getItem('csrftoken')
                        },
                        body: JSON.stringify({
                            albums: [parseInt(albumId)] // ƒê∆∞a albumId v√†o danh s√°ch theo ƒë√∫ng format API
                        })
                    })
                    .then(response => {
                        if (response.ok) {
                            {% comment %} albumElement.remove(); // X√≥a album kh·ªèi giao di·ªán {% endcomment %}
                            Toastify({
                                text: "X√≥a album th√†nh c√¥ng!",
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "center",
                                backgroundColor: "#4caf50", // M√†u xanh cho th√†nh c√¥ng
                                stopOnFocus: true,
                            }).showToast();
                            window.location.reload();
                        } else {
                            return response.json().then(errData => {
                                throw new Error(errData.detail || "L·ªói khi x√≥a album.");
                            });
                        }
                    })
                    .catch(error => console.error("Error deleting album:", error));
                }

                if (folder) {
                    const idAlbum = event.target.closest(".wrap-folder").getAttribute("data-album-id")
                    
                    fetch(`/album/${idAlbum}/`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Token ${localStorage.getItem('token')}`,
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('K·∫øt qu·∫£ t√¨m ki·∫øm h√¨nh ·∫£nh:', data.photos);
                        // Store the data in localStorage
                        localStorage.setItem('searchResults', JSON.stringify({
                            results : data.photos.map(item => {
                                return {
                                    ...item,
                                    photo : item.photo.replace('/store/', '')
                                }
                            }),
                        }));
                        // Redirect to the results page
                        window.location.href = `imgs?mode=image&album=${idAlbum}`;
                    })
                    .catch(error => {
                        console.error('L·ªói t√¨m ki·∫øm h√¨nh ·∫£nh:', error);
                        alert("C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm h√¨nh ·∫£nh, vui l√≤ng th·ª≠ l·∫°i!");
                    }); 
                }

            });
            
            const tabMenu = document.querySelector('.tab-menu');
            const tabs = tabMenu.querySelectorAll('a');
            const designSections = document.querySelectorAll('.design-section');
            tabs.forEach(tab => {
                tab.addEventListener('click', (event) => {
                    event.preventDefault();
                    const items  = document.querySelectorAll('.item-img');
                    {% comment %} console.log(items); {% endcomment %}

                    const selectedTab = tab.getAttribute('data-tab');
                    tab.classList.add('active');
                    tabs.forEach(t => {
                        if (t !== tab) {
                            t.classList.remove('active');
                        }
                    });
                    items.forEach(section => {
                        const sectionType = section.getAttribute('data-type');
                        if (selectedTab === 'all' || sectionType === selectedTab) {
                            section.style.display = 'block';
                        } else {
                            section.style.display = 'none';
                        }
                    });

                    checkEmptyState();
                });
            });
        });


        
        document.querySelectorAll('[data-public-filter]').forEach(filterItem => {
            filterItem.addEventListener('click', (event) => {
                event.preventDefault();
                const filterValue = event.target.getAttribute('data-public-filter');
                const items = document.querySelectorAll('.item-img[data-type="photo"]');
                {% comment %} const albumItems = document.querySelectorAll('.item-img[data-type="album"]');
                albumItems.forEach(item => {
                    item.style.display = 'block'; // Show all album items
                }); {% endcomment %}

                // Update dropdown button text
                let buttonText = "C·ªông ƒë·ªìng";
                if (filterValue === 'true') buttonText = "C·ªông ƒë·ªìng";
                else if (filterValue === 'false') buttonText = "Kh√¥ng c·ªông ƒë·ªìng";
                document.getElementById('communityFilterDropdown').textContent = buttonText;
                
                // Apply filter
                items.forEach(item => {
                    const isPublic = item.querySelector('.design-card').getAttribute('data-is-public') === 'true';
                    if (filterValue === 'all' || (isPublic && filterValue === 'true') || (!isPublic && filterValue === 'false')) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                checkEmptyState();
            });
        });
    
    </script>


    <script>
        // Use Event Delegation to handle the folder button clicks
        document.querySelector('.design-section').addEventListener('click', function (event) {
            if (event.target.closest('.btn.btn-folder')) {
                console.log("üìÅ Folder button clicked");

                const folderButton = event.target.closest('.btn.btn-folder');
                const photoCard = folderButton.closest('.design-card');
                const photoId = photoCard.getAttribute('data-photo-id');

                console.log("üì∏ Photo ID:", photoId);

                if (!photoId) {
                    console.error("‚ùå Kh√¥ng t√¨m th·∫•y ID ·∫£nh!");
                    return;
                }

                // Hi·ªÉn th·ªã modal ch·ªçn folder
                const folderModal = new bootstrap.Modal(document.getElementById('folderModal'));
                folderModal.show();

                // X·ª≠ l√Ω s·ª± ki·ªán khi ch·ªçn folder v√† nh·∫•n "ƒê·ªìng √Ω"
                document.getElementById('selectFolderBtn').addEventListener('click', function () {
                    const selectedCard = document.querySelector('.folder-card.active');

                    if (!selectedCard) {
                        alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt folder tr∆∞·ªõc khi x√°c nh·∫≠n!");
                        return;
                    }

                    const folderId = selectedCard.getAttribute('data-id');
                    const folderName = selectedCard.querySelector('p').textContent;

                    console.log(`üìÅ Folder ƒë∆∞·ª£c ch·ªçn: ID ${folderId}, T√™n: ${folderName}`);

                    // ƒê·ªãnh d·∫°ng d·ªØ li·ªáu JSON ƒë·ªÉ g·ª≠i ƒë·∫øn API
                    const requestData = [{
                        "id_photo": parseInt(photoId, 10),
                        "album": parseInt(folderId, 10)
                    }];

                    console.log("üì° G·ª≠i request PUT:", requestData);

                    // G·ª≠i request PUT ƒë·∫øn API
                    fetch('/photo/info/', {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Token ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'X-CSRFTOKEN': localStorage.getItem('csrftoken')
                            },
                            body: JSON.stringify(requestData)
                        })
                        .then(response => {
                            console.log("üì° Server response status:", response.status);
                            if (response.ok) {
                                window.location.reload();
                                {% comment %} return response.json(); {% endcomment %}
                            } else {
                                return response.json().then(errData => {
                                    throw new Error(errData.detail ||
                                        "‚ö†Ô∏è L·ªói khi c·∫≠p nh·∫≠t album.");
                                });
                            }
                        })
                        .then(data => {
                            console.log(
                                `‚úÖ ·∫¢nh ID ${photoId} ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√†o Album ID ${folderId}.`,
                                data);
                            folderModal.hide(); // ƒê√≥ng modal sau khi th√†nh c√¥ng
                            window.location.reload(); // C·∫≠p nh·∫≠t giao di·ªán
                        })
                        .catch(error => console.error("‚ùå L·ªói c·∫≠p nh·∫≠t album:", error));
                }, {
                    once: true
                }); // `once: true` ƒë·ªÉ tr√°nh g·∫Øn nhi·ªÅu s·ª± ki·ªán click
            }

            if (event.target.closest('.design-card img')) {
                // Handle image click
                const img = event.target.closest('.design-card img');
                const imgSrc = img.getAttribute('src');
                const photoId = img.closest('.design-card').getAttribute('data-photo-id');

                // Update src for the enlarged image in modal
                const enlargedImage = document.getElementById('enlargedImage');
                enlargedImage.src = imgSrc;

                // Show the modal using Bootstrap Modal
                const imageModalEl = document.getElementById('imageModal');
                const imageModal = new bootstrap.Modal(imageModalEl);
                imageModal.show();
            }

            if (event.target.closest('.btn-delete')) {
                const photoCard = event.target.closest('.design-card');
                const cardBody = event.target.closest('.card-body');
                const photoId = photoCard.getAttribute("data-photo-id");

                if (!photoId) {
                    console.error("Photo ID not found.");
                    return;
                }

                // X√°c nh·∫≠n x√≥a tr∆∞·ªõc khi g·ª≠i request
                if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh ID ${photoId} kh√¥ng?`)) {
                    return;
                }

                fetch(`/photo/delete/`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Token ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRFTOKEN': localStorage.getItem(
                                'csrftoken') // L∆∞u √Ω: C·∫ßn ƒë·∫£m b·∫£o CSRF token ƒë∆∞·ª£c l∆∞u
                        },
                        body: JSON.stringify({
                            "photos": [parseInt(photoId)] // Chuy·ªÉn ID ·∫£nh th√†nh s·ªë nguy√™n
                        })
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                            console.log(`Photo with ID ${photoId} deleted successfully.`);
                        } else {
                            return response.json().then(errData => {
                                throw new Error(errData.detail ||
                                "Failed to delete photo.");
                            });
                        }
                    })
                    .catch(error => console.error("Error deleting photo:", error));
            }

            if (event.target.closest('.btn-like')) {
                const photoCard = event.target.closest('.design-card');
                const photoId = photoCard.getAttribute("data-photo-id");
                const isFavorite = photoCard.getAttribute("data-is-favorite");

                if (!photoId) {
                    console.error("Photo ID not found.");
                    return;
                }

                if (!isFavorite) {
                    fetch(`/favorite/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Token ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'X-CSRFTOKEN': localStorage.getItem(
                                    'csrftoken') // C·∫ßn ƒë·∫£m b·∫£o CSRF token h·ª£p l·ªá
                            },
                            body: JSON.stringify({
                                "photos": [{
                                    "id_photo": parseInt(
                                    photoId), // Chuy·ªÉn ID ·∫£nh th√†nh s·ªë nguy√™n
                                    "note": "Favorite image" // Ghi ch√∫ t√πy ch·ªçn
                                }]
                            })
                        })
                        .then(response => {
                            if (response.ok) {
                                console.log(`Photo with ID ${photoId} added to favorites.`);
                                // C·∫≠p nh·∫≠t UI: ƒê·ªïi m√†u n√∫t ho·∫∑c th√™m hi·ªáu ·ª©ng y√™u th√≠ch
                                event.target.classList.add(
                                "favorited"); // Th√™m class ƒë·ªÉ thay ƒë·ªïi giao di·ªán
                            } else {
                                return response.json().then(errData => {
                                    throw new Error(errData.detail ||
                                        "Failed to favorite photo.");
                                });
                            }
                        })
                        .catch(error => console.error("Error favoriting photo:", error));
                } else {
                    fetch(`/favorite/`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Token ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'X-CSRFTOKEN': localStorage.getItem(
                                    'csrftoken') // C·∫ßn ƒë·∫£m b·∫£o CSRF token h·ª£p l·ªá
                            },
                            body: JSON.stringify({
                                "photos": [{
                                    "id_photos": parseInt(
                                    photoId), // Chuy·ªÉn ID ·∫£nh th√†nh s·ªë nguy√™n
                                }]
                            })
                        })
                        .then(response => {
                            if (response.ok) {
                                console.log(`Photo with ID ${photoId} removed from favorites.`);
                                // C·∫≠p nh·∫≠t UI: ƒê·ªïi m√†u n√∫t ho·∫∑c th√™m hi·ªáu ·ª©ng y√™u th√≠ch
                                event.target.classList.remove(
                                "favorited"); // X√≥a class ƒë·ªÉ thay ƒë·ªïi giao di·ªán
                            } else {
                                return response.json().then(errData => {
                                    throw new Error(errData.detail ||
                                        "Failed to unfavorite photo.");
                                });
                            }
                        })
                        .catch(error => console.error("Error unfavoriting photo:", error));
                }
            }

            if (event.target.closest('.btn-globe')) {
                const globeButton = event.target.closest('.btn-globe');
                const photoCard = globeButton.closest('.design-card');

                // L·∫•y ID ·∫£nh v√† album t·ª´ thu·ªôc t√≠nh data
                const photoId = photoCard.getAttribute("data-photo-id");
                const albumId = photoCard.getAttribute("data-album-id");
                var isPublic = photoCard.getAttribute("data-is-public");

                isPublic = isPublic === "true" ? false : true;

                if (!photoId || !albumId) {
                    console.error("Photo ID ho·∫∑c Album ID kh√¥ng t√¨m th·∫•y.");
                    return;
                }

                // ƒê·ªãnh d·∫°ng d·ªØ li·ªáu JSON ƒë·ªÉ g·ª≠i t·ªõi API
                const requestData = [{
                        "id_photo": parseInt(photoId, 10),
                        "album": parseInt(albumId, 10),
                        "is_public": isPublic // Chuy·ªÉn ƒë·ªïi gi√° tr·ªã boolean ng∆∞·ª£c
                    } // B·∫°n c√≥ th·ªÉ thay ƒë·ªïi n·∫øu c·∫ßn
                ];

                // G·ª≠i request PUT t·ªõi API
                fetch(`/photo/info/`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Token ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRFTOKEN': localStorage.getItem('csrftoken')
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                            return response.json();
                        } else {
                            return response.json().then(errData => {
                                throw new Error(errData.detail ||
                                    "Failed to update photo info.");
                            });
                        }
                    })
                    .then(data => {
                        console.log(`Photo ID ${photoId} updated successfully in Album ${albumId}.`,
                            data);
                    })
                    .catch(error => console.error("Error updating photo info:", error));
            }

            if (event.target.closest('.btn-edit')) {
                const photoCard = event.target.closest('.design-card');
                const photoId = photoCard.getAttribute("data-photo-id");
                const albumId = photoCard.getAttribute("data-album-id");
                
                // Find the card title and text related to this specific photo
                const cardContainer = photoCard.closest('.item-img');
                const cardTitle = cardContainer.querySelector(".card-title");
                const cardText = cardContainer.querySelector(".card-text");
                
                if (!photoId) {
                    console.error("Photo ID not found.");
                    return;
                }
            
                // L∆∞u gi√° tr·ªã photoId, albumId v√†o modal ƒë·ªÉ s·ª≠ d·ª•ng sau
                const editModal = document.getElementById("editInfoModal");
                editModal.dataset.photoId = photoId;
                editModal.dataset.albumId = albumId;
            
                // Get current data from the clicked card
                document.getElementById("inputName").value = cardTitle ? cardTitle.textContent || "" : "";
                document.getElementById("inputCaption").value = cardText ? cardText.textContent || "" : "";
                document.getElementById("inputDescription").value = ""; // Reset description field
            
                // Hi·ªÉn th·ªã modal b·∫±ng Bootstrap Modal API
                const bsModal = new bootstrap.Modal(editModal);
                bsModal.show();
            
                // ƒêƒÉng k√Ω s·ª± ki·ªán cho n√∫t "L∆∞u thay ƒë·ªïi" trong modal, ch·ªâ th·ª±c hi·ªán 1 l·∫ßn
                document.getElementById("saveChangesBtn").addEventListener("click", function handler() {
                    const nameValue = document.getElementById("inputName").value;
                    const captionValue = document.getElementById("inputCaption").value;
                    const descriptionValue = document.getElementById("inputDescription").value;
            
                    // T·∫°o d·ªØ li·ªáu JSON theo ƒë·ªãnh d·∫°ng y√™u c·∫ßu
                    const data = [{
                        id_photo: parseInt(photoId, 10),
                        album: parseInt(albumId, 10),
                        ...(nameValue ? { name: nameValue } : {}),
                        ...(captionValue ? { caption: captionValue } : {}),
                        ...(descriptionValue ? { description: descriptionValue } : {})
                    }];
                    
                    fetch("/photo/info/", {
                            method: "PUT",
                            headers: {
                                "accept": "application/json",
                                'Authorization': `Token ${localStorage.getItem('token')}`,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(data)
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Network response was not ok");
                            }
                            return response.json();
                        })
                        .then(json => {
                            console.log("Success:", json);
                            bsModal.hide();
                            window.location.reload();
                        })
                        .catch(error => {
                            console.error("Error:", error);
                        });
            
                    // X√≥a s·ª± ki·ªán sau khi ƒë√£ th·ª±c hi·ªán ƒë·ªÉ tr√°nh l·∫∑p l·∫°i khi m·ªü modal l·∫ßn sau
                    this.removeEventListener("click", handler);
                }, { once: true });
            }

        });

        function fetchFolders() {
            fetch('/album', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${localStorage.getItem('token')}`,
                        'Accept': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const albumContainer = document.getElementById("folderGrid");
                    data.forEach(album => {
                        const col = document.createElement('div');
                        col.classList.add('col-4', 'mb-3');

                        const card = document.createElement('div');
                        card.classList.add('card', 'folder-card');
                        card.style.cursor = 'pointer';
                        card.setAttribute('data-id', album.id_album);
                        card.innerHTML = `
                        <div class="card-body text-center">
                            <i class="fas fa-folder fa-3x"></i>
                            <p class="mt-2" style="color : black!important">${album.title}</p>
                        </div>
                    `;

                        // Event listener for folder card click using event delegation
                        card.addEventListener('click', () => {
                            document.querySelectorAll('.folder-card').forEach(item => item
                                .classList
                                .remove('active'));
                            card.classList.add('active');
                        });

                        col.appendChild(card);
                        folderGrid.appendChild(col);
                    });
                })
                .catch(error => console.error("Error fetching albums:", error));
        }
        fetchFolders();
    </script>


        

{% endblock %}